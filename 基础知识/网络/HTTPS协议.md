

# HTTPS协议

[TOC]


## 概述
* HTTPS将HTTP底层的TCP/IP协议改成了SSL/TLS协议
* SSL (Secure Socket Layout)，最初有网景公司开发，有v2,v3两个版本
* TLS (Transport Layout Security)，由互联网工程组基于SSLv3改名

![](http://picbed.cc12703.com/20230123150113.png)


### 安全特性
* `机密性`：数据的保密，外人对数据是不可见的
* `完整性`：数据传输过程中没有被篡改
* `身份认证`：可以确认对方的真实身份
* `不可否认`：不能否认已经发生过的行为


### SSL/TLS功能
* 所有信息都是加密的，第三方无法窃听
* 具有校验机制，被篡改后双方会立刻发现
* 配备身份证书，防止身份被冒充




## 基础

### 加密套件
* 一组加密算法的组合
* 命名格式：`密码交换算法-签名算法-对称加密算法-分组模式-摘要算法`
* 例子：`ECDHE-RSA-AES256-GCM-SHA384`
    * 使用ECDHE进行密钥交换
    * 使用RSA进行签名和身份认证
    * 使用AES进行对称数据加密，分组模式为GCM
    * 使用SHA进行消息认证和产生随机数


### 混合加密
* 使用非对称加密算法，进行`会话密钥`交换
    * `会话密钥`由随机数生成
* 使用对称加密算法和`会话密钥`，对后续数据进行加密

![](http://picbed.cc12703.com/20230123152303.png)


### 摘要算法
* 实现完整性的主要手段
* 方法：使用哈希函数将任意长度的数据压缩成固定长度的数据（摘要）
* 常用：MD5，SHA-1, SHA-2


### 哈希消息认证码
* 使用会话密钥加密消息和摘要

![](http://picbed.cc12703.com/20230123153013.png)


### 数字签名
* 方法：使用`私钥`加密`原文的摘要`,作为签名信息

![](http://picbed.cc12703.com/20230123154642.png)


### 数字证书
* 作用：解决公钥认证问题
* 方法：使用一个公认的可信第三方（信任的起点），构建起一个公钥的信任链
* 第三方就称为CA（证书认证机构）
    * 包括：DigiCert, Let`s Encrypt, VeriSign
* 数字证书就是CA对公钥的签名认证包
    * 内容：序列号、用途、签发者、有效时间



## 协议

### 子协议
* 记录协议：底层协议，负责加密数据，基本单位为`记录`
* 握手协议：负责协商信息、交换证书、生成会话密钥
* 警报协议：向对方发出警报信息，类似于HTTP中的状态码
* 变更密码规范协议：向对方发送一个通知，后续要加密数据了


### 握手协议

#### 作用
1. 客户端获得了服务器的合法公钥，完成了服务器认证
1. 服务器获得了客户端的合法公钥，完成了客户端认证
1. 客户端、服务器生成了通信中使用的共享密钥


#### 流程
1. 客户端发送`client hello`消息
    * 客户端的版本号、支持的加密套件
    * 客户端生成的随机数
1. 服务器发送`server hello`消息
    * 确认需要使用的加密套件
    * 服务器生成的随机数

1. 服务器发送`server certificate`消息
    * 服务器使用的证书
    * 客户端需要验证
1. 服务器发送`server key exchange`消息
    * 密钥交换算法参数
    * 服务器的私钥签名认证
1. 服务器发送`server hello done`消息

1. 客户端发送`client certificate`消息
    * 客户端使用的证书
    * 服务器需要验证
1. 客户端发送`client key exchange`消息
    * 密钥交换算法参数
1. 客户端发送`change cipher spec`消息
1. 客户端发送`finished`消息
    * 所有握手数据的摘要

1. 服务器发送`change cipher spec`消息
1. 服务器发送`finished`消息

#### 流程图示
![](http://picbed.cc12703.com/20230123174425.png)


#### 密钥
* 预备主密钥（Pre-Master）：使用密钥交换算法，通过客户端随机数和服务器随机数计算得到
* 主密钥（Master Secret）：通过客户端随机数、服务器随机数、预备主密钥计算得到
* 会话密钥：通过主密钥扩展产生