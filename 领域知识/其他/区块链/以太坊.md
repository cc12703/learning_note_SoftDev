

# 以太坊

[TOC]

## 概述

### 特点
* 有更快的`出块`速度
	* 比特币出块时间：10分钟
	* 以太坊出块时间：12秒
* 支持智能合约
	* 以太坊可以作为通用的区块链平台，支持DApp
* 核心：
	* 交易
	* 智能合约
	* DApp


### 架构
* 底层服务：P2P网络、LevelDB数据库
* 核心层：区块链、共识算法、虚拟机
* 顶层应用：API接口、智能合约、去中心化应用

#### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/Snip20220202_6.png)



## 以太币

### 概述
* 以太坊发行的一种数字货币
* 发起任何交易都需要支付一定的以太币

### 来源
* 矿前预售
* 区块奖励
* 叔区块奖励（不在主链上的区块）
* 叔区块引用奖励

#### 矿工奖励
* 静态奖励：一个新区块，获取5个以太币
* 动态奖励：区块中所有交易的交易费

### 单位
* 最小单位：`wei`
* 最大单位：`ether`, `1 ether = 1e18 wei`

## 区块链

### 概述
* 使用了改进的比特币的区块链技术
* 改进点：保存了三棵改进的Merkle树（状态树、交易树、收据树）

### 区块
* 区块头
* 交易列表
* 叔区块头

### 区块头
* 父块的散列值
* 叔区块的散列值
* 状态树根的散列值
* 交易树根的散列值
* 收据树根的散列值
* 时间戳
* 随机数

### 数据组织
* 重要数据使用MPT树进行组织
	* MPT => Merkle Patricia Trie
	* MPT是一种加密认证树
	* MPT融合了Merkle树和Trie树的优点
* 状态树、交易树、收据树分别为三棵MPT树
* 三棵MPT树的功能
	* 判断一个账户是否存在
	* 判断某交易是否在特定区块中
	* 查找某账户余额
	* 查找合约中特定交易的输出


#### 状态树
* 全局只有一棵状态树
* 包含一个键值映射
	* 键：账户地址
	* 值：账户状态（交易序列数，余额、代码散列值、另一棵树的根节点）

#### 交易树
* 每个区块都有一棵独立的交易树
* 包含一个键值映射
	* 键：交易编号
	* 值：交易内容

#### 收据树
* 每个区块都有一棵独立的收据树
* 包含一个键值映射
	* 键：索引编号
	* 值：收据内容


### 数据存储
* 使用了三个LevelDB数据库
* BlockDB保存了区块的主体内容：块头、交易
* StateDB保存了账户的状态数据
* ExtrasDB保存了收据信息和其他辅助信息




## 账户

### 概述
* 使用地址进行索引，地址由公钥生成
* 数据保存在区块链中的状态树中

### 类型
* 外部账户
	* 拥有一对公私钥，由私钥控制
	* 可以发送交易
* 合约账户
	* 包含了智能合约的代码
	* 由合约代码控制

### 数据
* 交易的次数
	* 用于保障每笔交易只能处理一次
* 以太币余额
* 智能合约的二进制代码
* 其他数据


## 交易

### 概述
* 由外部账户发起的签名消息
* 交易是唯一可以触发状态变更、执行合约的东西
* 交易是一个序列化的二进制消息

### 交易字段
* nonce 外部账号发出的序列号，用于防止消息重播

* gas price 发起者愿意支付的Gas价格
* gas limit 发起者愿意支付的最大Gas量

* from 发送者地址

* to   目标以太坊地址
* value 要发送的以太币数量
* data 变长的二进制数据，用于创建、调用智能合约



* hash 交易内容生成的散列值，作为交易ID
* r,s,v 交易签名

### 交易类型
* 转账交易
* 创建智能合约交易：将合约部署到区块链上
	* to 为空
	* data 合约的二进制代码
* 执行智能合约交易
	* to 合约的地址
	* data 要调用的方法和传递的参数


### 流程
1. 发送者创建交易，向网络发送
1. 其他节点收到该交易，检查该交易是否有效
	* 若无效，则直接丢弃
	* 若有效，则加入交易池，并进行转发
1. 获得记账权的节点处理交易，生成区块，向网络发送
	* 转账：打包到区块
	* 调用合约：在本地EVM中运行合约代码
	* 创建合约：创建合约账户，部署合约，将合约地址发回发送者
1. 其他共识节点收到该区块，验证该区块
	* 若验证通过，则区块被加入本地的区块链中
	* 调用的合约会在本地EVM中运行一次，以验证运行结果


## 智能合约

### 概述
* 区块链上一个包含了合约代码和存储空间的虚拟账户
* 合约代码控制合约的行为
* 存储空间保存了合约的状态
* 合约代码运行在以太坊虚拟机(EVM)中


#### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/20220202231207.png)


![](https://gitee.com/cc12703/figurebed/raw/master/img/20220202232258.png)


#### 优点
* 合约条款由代码确定，更不容易产生歧义
* 合约存储、部署在区块链中，执行结果几乎不可能被篡改
* 合约创建、执行都依赖于区块链协议，保证合约被强制执行


## Gas

### 概述
* 用于衡量一笔交易所消耗的计算资源的基本单位
* 智能合约程序执行的每项操作都需要一定数量的Gas

### Gas价格
* 一单位Gas所需要的手续费（以太币）
* 用户创建交易时，可以指定任意的Gas价格

### Gas限制
* 对于单个交易，限制支付的最大Gas数量
	* 用户创建交易时可以设置
	* 保护用户免受错误代码导致的交易费消耗过多
* 单个区块，限制区块所包含的最大Gas总量
	* 矿工创建区块前设置
	* 用于平衡获取的交易费和需要的带宽

### 作用
* 作为以太币价格和矿工奖励之间的抽象层
* 抵御拒绝服务攻击


## 共识

### PoW
* 使用了Ethash算法，解决挖矿中心化的问题

#### 特点
* 挖矿效率与CPU无关，而与内存大小、带宽正相关

#### 流程
1. 生成一个1GB的数据集（DAG）
	1. 每个区块，通过扫描区块头计算出一个种子
	1. 使用种子产生一个16MB的伪随机缓存
	1. 使用缓存生成一个1GB的数据集
1. 矿工从DAG中随机选择元素并对其进行散列计算
1. 验证者只需要存储缓存就可以进行验证
1. 缓存和DAG每增加3万个区块更新一次


### PoS
* 一种对货币所有权的证明
* 基于参与者所持有的数字货币的数量和时间


#### 方法
* 成为验证者：发起一笔特殊形式的交易，将其以太币锁定在一个存储中
* 所有验证者参与一个共识算法，完成新区块的产生和验证

#### 类型
* 基于链的PoS
* BFT(拜占庭容错)风格的PoS


#### 基于链的PoS
1. 每个时隙随机地从验证者集合中选择一个验证者，可以创建区块
1. 其他验证者要确保新区块指向最多的块


#### BFT风格的PoS
1. 每个验证者都可以创建提出块
1. 每个验证着需要对提出的块进行投票，以决定哪个块为新区块
1. 每一轮都投票选出一个新区块加入区块链



## Solidity

### 概述
* 用于编写智能合约的高级语言
* 语法类似于JavaScript
* 静态类型语言

#### 示例
```js
contract Simple {
	uint data;   //状态变量
	address public creater;

	event Deposit(address _from, uint _amount);  //事件

	function Simple() {   //构造函数
		creater = msg.sender
	}

	modifier onlyCreater() {   //函数修改器
		require(msg.sender == creater);
		_;  //调用原函数代码
	}

	function abort() onlyCreater {

	}
}
```

### 数据类型
* 布尔值
* 整数：有符号、无符号
* 定点数
* 地址
* 定长的字节数组
* 动态的字节数组
* 枚举值
* 结构
* 映射
* 时间单位：seconds, minutes, hours, days
* 以太单位：wei, finney, szabo, ether


### 全局对象
* msg 调用交易对象
* tx  交易上下文对象
* block 区块上下文对象
* address 地址

## Token 代币

### 概述
* 用途：作为货币、资源、资产、权益、身份
* 类型：
	* 可互换性Token：所代表的东西是可以互换的
	* 不可互换性Token：所代表的东西是独特的
* 优点：将外部资产转换为内部资产（受共识规则约束），消除交易对手风险


### ERC20标准 
* 一个可互换Token的标准
* 给实现Token的合约定义了一个通用接口

#### 功能
* 查找当前存在的Token总单位
* 获取指定地址的Token余额
* 在地址之间转账Token
* 授权地址从批准的账号中执行多次转账 

#### 工作流程
* 单次交易流程：使用`transfer`接口
* 双交易流程：使用`approve`和`transferFrom`接口


#### 双交易流程

图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/20220208153320.png)

步骤
1. Alice发布AliceCoin合约
1. Alice发布AliceICO合约，用于出售Token
1. Alice向AliceCoin发送一个交易
	* 调用`approve`接口，用于授权AliceICO
1. Bob向AliceICO转移一些以太币
1. AliceICO根据设置的汇率确定要给Bob的Token
1. AliceICO调用AliceCoin的`transferFrom`接口
1. AliceCoin将指定数量的Token从Alice转账给Bob


## DApp

### 组件
* 包括 前端、后端、数据存储

#### 后端
* 后端运行在以太坊的智能合约上
* 智能合约用于程序的业务逻辑、状态、计算
* 缺点：
	* 部署后无法更改代码
	* 大的智能合约会消耗大量的Gas

#### 前端
* 使用Web技术构建

#### 数据存储
* 利用去中心化存储来存储和分发大型静态资产
	* 图像、视频、客户端应用程序
	* IPFS, Swarm
* 内容的哈希值会存储在智能合约中


### 框架
* Truffle
* Embark
* Emerald


### ENS 以太坊域名服务

#### 概述
* 建立在区块链上的分布式、开放的命名系统
* 作用：将散列地址翻译成一个简短易记的地址
* 是以太坊基金会提供的去中心化应用

#### 组件
* 注册表：系统的核心
* 解析器：由用户实现
* 注册服务：一个智能合约
	* 用户需要通过竞拍方式获取域名

#### 竞拍流程
1. 每个竞标者出价一次，并等待竞价期结束
1. 竞价期结束后，每个竞标者进行揭标
	* 向其他竞价者显示竞价
	* 不揭标者会被没收竞价金
1. 揭标后出价最高的竞价者获胜，只需要付第二高竞价的金额
	* 竞价金会以保证金的形式存放在个人的契约账户中