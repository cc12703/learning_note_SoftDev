

# 比特币

[TOC]

## 概述

* 比特币是基于去中心化的信任，由系统中不同用户自发达成
* 区块链是一个分布式的公开、权威账簿
	* 包含了发生的所有交易
* 没有传统的账号概念


### 核心点

#### 交易
* 类比于程序中的数据
* 核心数据：交易输出
* 交易输出内容：币数量，锁定脚本、公钥

#### 区块链
* 类比于程序中的数据存储，用于组织存储交易
* 核心数据：区块头哈希、Merkle树
	* 作用：对数据进行校验
 
#### 钱包
* 类比于程序中的代码，用于创建交易
* 只管理密钥对，币存在在区块链上（UTXO）
* 创建交易时需要对内容进行签名，防止抵赖

#### 矿工
* 类比于程序中的代码，用于将交易打包成区块，扩展区块链
* 共识核心
	* 工作量证明算法（投入的成本）
	* 各个节点独立校验区块
* 共识原理
	* 按规则行事会有奖励
	* 破坏规则行事会有惩罚





## 交易

### 概述
* 交易包括多个输入和多个输出
* 输入是另一笔交易的输出，形成一个交易链（所有权链）
* 一个交易链的头为创币交易
* 大部分交易都会包含**找零**输出（输入是不可分割的）

#### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/20211231144839.png)

#### UTXO
* UTXO指未花费的交易输出
* UTXO是不可分割的，在一次交易中作为一个整体被消耗的


### 结构

#### 输出内容
* 一定量的比特币，单位为”聪“
* 一个锁定脚本，确定花费输出所需条件的加密难题

##### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/20211231150926.png)

#### 输入内容
* 一个交易ID，用于引用要消费的交易
* 一个输出索引，标识要用的UTXO
* 一个解锁脚本，用于解决UTXO的加密难题
* 一个序列号

##### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/20211231151026.png)


### 交易费
* 交易费指输入和输出之间的差值
* 目的：
	* 对矿工保护网络安全的补偿
	* 安全机制，增加攻击者发送大量交易的经济成本
* 交易费基于交易的千字节（KB）大小来计算的
* 交易费会影响矿工处理交易的优先级


### 地址
* 地址由公钥经过哈希算法得到
* 公式： `Addr = RIPEMD160 ( SHA256 (Key) )`
* 地址还会使用 Base58Check 进行编码
	* 目的：紧凑、易读、有错误校验

#### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/20211231155001.png)



### 流程
1. 钱包创建交易，用户输入目标地址和金额
	* 通过扫描区块链，获取该钱包所有的UTXO作为交易输入
	* 使用锁定脚本来创建交易输出
1. 交易通过比特币网络传播给所有节点
	* 节点会校验交易的有效性，只传播有效的交易
1. 交易被打包进区块
	* 矿工会将新交易放入临时交易池
	* 通过工作量证明算法，使用交易池中的交易生成新区块
1. 区块通过网络传播给所有矿工
1. 区块被添加进区块链
	* 矿工会校验新区块的有效性
	* 有效的区块会被加入区块链中


## 区块链

### 概述
* 由包含交易信息的区块，按照从远到近的顺序有序链接起来的数据结构
* 每个区块都指向前一个区块
* 第一个区块为**创世区块**，被写入到软件代码中的
* 对区块头进行哈希生成一个哈希值，用于识别该区块

### 区块
* 作用：聚合交易信息
* 字段
	```
		blk_size：区块大小
		blk_head：区块头
		transaction_count：交易数量
		transaction：交易列表
	```

#### 区块头
* 字段
	```
		version：版本号
		pre_blk_hash：前一个区块的哈希值
		merkle_root：Merkle树根的哈希值
		time_stamp：创建时间戳
		target： 工作量证明算法的难度目标值
		nonce：工作量证明算法用的随机数
	```

#### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/20220103012846.png)


#### Merkle树
* 一种哈希二叉树
* 用于归集一个区块中的所有交易，生成所有交易的数字指纹
* 所有交易的哈希值会存在树的叶子节点中

##### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/20220210135751.png)


## 钱包

* 钱包只包含密钥，不是币。币被记录在区块链中

### 功能
* 管理多个密钥和地址
* 跟踪余额
	* 用包含的密钥可以消费的所有UTXO的总和
* 创建、签名交易


### 类型
* 非确定性钱包：每个密钥独立生成的，彼此无关（JBOK钱包）
* 确定性钱包：密钥从一个主密钥派生出来。（HB钱包）

### HB钱包
* 密钥以树状结构进行衍生
* 图示 ![](https://gitee.com/cc12703/figurebed/raw/master/img/20211231164433.png)

#### 优点
* 树状结构可以被用来表达附加的组织含义
* 可以在不需要对应私钥的情况下，创建一系列公钥



## 挖矿和共识

### 概述
* 挖矿一种激励机制，实现了去中心化的安全
* 挖矿在去中心化的情况下实现了全网范围的共识
* 共识由许多独立节点遵守了简单的规则，通过异步交互自发形成的
* 核心点
	* 工作量证明算法
	* 各个节点独立校验（区块）

### 如何保证安全
* 挖矿在成本和报酬之间取得了良好的平衡
* 矿工耗费电力（成本）来解决数据问题
* 矿工挖矿成功后会获得新的比特币和交易费作为奖励（报酬）
* 只有其他矿工验证了该区块的有效性，该矿工才能拿到奖励

### 重要过程
* 每个节点独立验证每个交易（依据综合标准）
* 每个挖矿节点独立将交易打包进区块（通过工作量证明算法）
* 每个节点独立对区块进行校验，并加入区块链
* 每个节点独立选择区块链（选择累积工作量最大的区块链）


### 工作量证明
* 在构建新区块时通过反复修改nonce值，计算出一个特定的区块头哈希值
	* 该哈希值要小于难度目标的哈希值


#### 难度调整
* 调整由每个节点独立完成
* 每生成2016个区块后就会调整一次
* 调整的目标：保证区块平均每10分钟生成一个
	* 区块生成速率比10分钟快就增加难度，比10分钟慢就降低难度


### 创币交易
* 区块中的第一笔交易
* 由挖矿节点自己构建：将奖励金额支付给矿工
* 奖励金额：coinbase奖励 + 区块中所有交易手续费（交易输入和输出的差值）


## P2P网络

### 作用
* 节点之间相互发现
* 传播交易、区块
* 同步区块链

### 核心功能
* 钱包(W)
	* 管理密钥
	* 跟踪余额
* 挖矿(M)
	* 运行工作量证明算法
	* 以竞争的方式创建新的区块
* 区块链(B)
	* 保存一份完整的、最新的区块链拷贝
	* 独立自主地检验所有交易
* 网络路由(N)
	* 验证、传播交易和区块信息
	* 发现、维持与对等节点的连接


### 组成
* 核心节点：钱包、挖矿、区块链、网络路由
	* 组成比特币的核心网络
* 全节点：区块链、网络路由
	* 用于搭建其他服务：钱包、区块链浏览器、交易所
* 独立挖矿节点：挖矿、区块链、网络路由
* 矿池节点
	* 矿池服务器节点
	* 挖矿节点：挖矿
* 轻量钱包节点（SPV）：钱包、网络路由

#### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/Snip20220117_5_1.png)


### 节点发现

#### 发现
* 使用**DNS种子**来查询DNS，获取其他节点的IP地址

#### 握手
1. 新节点发送`version`消息
1. 对等节点确认兼容后，发送`verack`消息
1. 对等节点发送`version`消息
1. 新节点确认兼容后，发送`verack`消息

##### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/20220210114736.png)


#### 传播地址
* 新节点发送`addr`消息，将IP地址发送给对等节点
* 新节点发送`getaddr`消息，从对等节点中获取其他节点的IP地址

##### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/20220210120637.png)


### 同步区块链

#### 流程
1. 节点间交换`getblocks`消息，包含本地区块链的顶端区块的信息
1. 节点发送`inv`消息，传播需要分享的区块的哈希值
1. 节点间发送`getdata`消息，获取区块的全部信息

#### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/20220210135120.png)


## 脚本

### 概述
* 一种逆波兰表示法的基于堆栈的执行语言
* 图灵非完备的
	* 除了条件控制外，没有循环或更复杂的流程控制
* 无状态验证
	* 执行时需要的信息已包含在脚本中
* 交易验证依赖于：锁定脚本、解锁脚本


### 验证脚本

#### 锁定脚本
* 一个放置在交易输出上的**花费条件**：花费这笔输出必须要满足的条件
* 多数包含一个比特币地址

#### 解锁脚本
* 用于满足锁定脚本放置的条件
* 多数包含一个钱包生成的数字签名

#### 验证步骤
1. 从交易输入复制解锁脚本
1. 检索交易输入引用的UTXO，并复制其上的锁定脚本
1. 依次执行解锁脚本、锁定脚本
1. 获取结果：真、假


### P2PKH脚本
* Pay-to-Public-Key-Hash 付款至公钥哈希
* 图示 ![](https://gitee.com/cc12703/figurebed/raw/master/img/20211231171015.png)
* 验证脚本内容
	```
		<签名> <公钥> OP_DUP OP_HASH160
		<公钥哈希> OP_EQUALVERIFY OP_CHECKSIG
	```
* 指令含义
	* EQUALVERIFY：检查交易中的公钥和用户传入的公钥是否一样
	* CHECKSIG：检查签名信息和公钥是否匹配
* 验证流程
![](https://gitee.com/cc12703/figurebed/raw/master/img/20220105152300.png)
![](https://gitee.com/cc12703/figurebed/raw/master/img/20220105152325.png)


### 多重签名
* 作用：设置了一个条件，脚本中记录了N个公钥，至少提供M个签名才能解锁
* 锁定脚本
	* 格式：``` M <PubK 1> <PubK 2> ... <PubK N> N OP_CHECKMULTISIG ```
* 解锁脚本
	* 格式：``` <Sig 1> <Sig 2> ```
* 问题：
	1. 创建交易时需要生成复杂的锁定脚本
	1. 锁定脚本会变的很大

### P2SH脚本
* Pay-to-Script-Hash 付款至脚本哈希
* 作用：解决多重签名使用过程中的问题
* 方法：将复杂的锁定脚本替换为该脚本的哈希值
* 兑换脚本
	* 内容为多重签名中的锁定脚本
* 锁定脚本
	* 格式：``` HASH160 <Redeem Script Hash> EQUAL ```
* 解锁脚本
	* 格式：``` <Sig 1> <Sig 2> ```


### RETURN操作符
* 作用：允许在交易输出上增加80字节的非支付数据
* 该交易输出是一种**可验证不可消费型**输出，不会进入UTXO集
* 脚本格式：` RETURN <data> `
	* data多为哈希值


### 绝对时间锁
* 对交易输出进行限制，只允许在一个时间点之后才能消费
* 时间点可以是区块链高度、Unix纪元时间戳
* 需要和交易中的交易锁配合使用


#### CLTV
* 含义：检查锁定时间验证，Check Lock Time Verify 
* 作用：锁定UXTO, 使其只能在大于、等于交易时间锁设置的时间才能使用
* 锁定脚本
	```
		<未来的时间> OP_CHECKLOCKTIMEVERIFY	
		OP_DUP OP_HASH160
		<公钥哈希> OP_EQUALVERIFY OP_CHECKSIG
	```

### 相对时间锁
* 对交易输出进行限制，时间依赖于前一个交易被确认
* 需要和交易输入中的序列号配合使用


## 签名

### 作用
* 证明是资金所有者，有权花费这些资金
* 证明交易没有被修改过
* 具有不可否认性

### 生成
* 使用ECDSA算法
* 消息为交易信息、交易部分信息
* 密钥为用户私钥
* 使用DER进行序列化


### 类型（SIGHASH）
* 签名是签名者对特定交易数据的承诺
* 承诺的范围由SIGHASH给出

#### 组成
* 值：ALL, NONE, SINGLE
* 标识符：ANYONECANPY

#### 范围
![](https://gitee.com/cc12703/figurebed/raw/master/img/20220105160757.png)


#### 举例
* ALL|ANYONECANPY 可以用来做“众筹”交易
	* 发起人构建一个只有单笔输出的交易（付款给发起人）
	* 捐赠人将输入加入该交易，并使用该SIGHASH来签名
* NONE 可以创建“空白支票”
	* 拥有者只对交易的输入签名
	* 任何人都可以修改交易的输出，并签名交易





## 应用

### 染色币
* 想法：利用比特币交易来记录外部资产的创建、所有权转让
* 作用：跟踪第三方持有的数字资产和实物资产，并通过所有权证书来进行交易
* 方法：使用OP_RETURN操作码将交易中的元数据、外部资产的关联数据存储在区块链上


### 状态通道
* 资金交易（链上）
	* 用于建立一个状态通道
	* 通过区块链交易锁定一个共享状态（初始余额）
* 承诺交易（链外）
	* 双方交互已签名的交易
	* 会改变通道的初始状态
	* 同时废止之前的承若交易
* 结算交易（链上）
	* 用于关闭状态通道
	* 可以合作关闭、单方面关闭