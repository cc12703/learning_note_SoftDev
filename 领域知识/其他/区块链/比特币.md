

# 比特币

[TOC]

## 概述

* 比特币是基于去中心化的信任，由系统中不同用户自发达成
* 核心模块：
	* 区块链（数据）
	* 钱包（创建交易）
	* 矿工（将交易打包成区块，扩展区块链）
* 区块链是一个分布式的公开、权威账簿
	* 包含了发生的所有交易



## 交易

### 概述
* 交易包括多个输入和多个输出
* 输入是另一笔交易的输出，形成一个交易链（所有权链）
* 一个交易链的头为创币交易
* 大部分交易都会包含**找零**输出（输入是不可分割的）

#### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/20211231144839.png)

#### UTXO
* UTXO指未花费的交易输出
* UTXO是不可分割的，在一次交易中作为一个整体被消耗的



### 结构

#### 输出内容
* 一定量的比特币，单位为”聪“
* 一个锁定脚本，确定花费输出所需条件的加密难题

##### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/20211231150926.png)

#### 输入内容
* 一个交易ID，用于引用要消费的交易
* 一个输出索引，标识要用的UTXO
* 一个解锁脚本，用于解决UTXO的加密难题
* 一个序列号

##### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/20211231151026.png)


### 交易费
* 交易费指输入和输出之间的差值
* 目的：
	* 对矿工保护网络安全的补偿
	* 安全机制，增加攻击者发送大量交易的经济成本
* 交易费基于交易的千字节（KB）大小来计算的
* 交易费会影响矿工处理交易的优先级


### 地址
* 地址由公钥经过哈希算法得到
* 公式： `Addr = RIPEMD160 ( SHA256 (Key) )`
* 地址还会使用 Base58Check 进行编码
	* 目的：紧凑、易读、有错误校验

#### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/20211231155001.png)




## 脚本

### 概述
* 一种逆波兰表示法的基于堆栈的执行语言
* 图灵非完备的
	* 除了条件控制外，没有循环或更复杂的流程控制
* 无状态验证
	* 执行时需要的信息已包含在脚本中
* 交易验证依赖于：锁定脚本、解锁脚本


### 验证脚本

#### 锁定脚本
* 一个放置在交易输出上的**花费条件**：花费这笔输出必须要满足的条件
* 多数包含一个比特币地址

#### 解锁脚本
* 用于满足锁定脚本放置的条件
* 多数包含一个钱包生成的数字签名

#### 验证步骤
1. 从输入复制解锁脚本
1. 检索输入引用的UTXO，并复制其上的锁定脚本
1. 依次执行解锁脚本、锁定脚本
1. 获取结果：真、假


### P2PKH脚本
* Pay-to-Public-Key-Hash 付款至公钥哈希
* 图示 ![](https://gitee.com/cc12703/figurebed/raw/master/img/20211231171015.png)
* 验证脚本内容
	```
		<签名> <公钥> OP_DUP OP_HASH160
		<公钥哈希> OP_EQUALVERIFY OP_CHECKSIG
	```

### 多重签名
* 作用：设置了一个条件，脚本中记录了N个公钥，至少提供M个签名才能解锁
* 锁定脚本
	* 格式：``` M <PubK 1> <PubK 2> ... <PubK N> N OP_CHECKMULTISIG ```
* 解锁脚本
	* 格式：``` <Sig 1> <Sig 2> ```
* 问题：
	1. 创建交易时需要生成复杂的锁定脚本
	1. 锁定脚本会变的很大

### P2SH脚本
* Pay-to-Script-Hash 付款至脚本哈希
* 作用：解决多重签名使用过程中的问题
* 方法：将复杂的锁定脚本替换为该脚本的哈希值
* 兑换脚本
	* 内容为多重签名中的锁定脚本
* 锁定脚本
	* 格式：``` HASH160 <Redeem Script Hash> EQUAL ```
* 解锁脚本
	* 格式：``` <Sig 1> <Sig 2> ```



### 数字签名

* 比特币使用了ECDSA算法（椭圆曲线）
* 交易的每笔输入都是独立签名的
* 使用SIGHASH标志，来表明签名应用的范围




## 区块链

### 概述
* 由包含交易信息的区块，按照从远到近的顺序有序链接起来的数据结构
* 每个区块都指向前一个区块
* 多区块头进行哈希生成一个哈希值，用于识别该区块

### 区块
* 作用用于聚合交易信息
* 结构
	```
		blk_size：区块大小
		blk_head：区块头
		transaction_count：交易数量
		transaction：交易列表
	```

#### 区块头
* 结构
	```
		version：版本号
		pre_blk_hash：前一个区块的哈希值
		merkle_root：Merkle树根的哈希值
		time_stamp：创建时间戳
		target： 工作量证明算法的难度目标值
		nonce：工作量证明算法用的随机数
	```

#### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/20220103012846.png)


#### Merkle树
* 一种哈希二叉树
* 用于归纳一个区块中的所有交易，生成所有交易的数字指纹


## P2P网络

### 节点
* 核心节点、全节点：钱包、挖矿、区块链、网络路由
* 独立挖矿节点：挖矿、区块链、网络路由
* 轻量钱包节点（SPV）：钱包、网络路由
* 矿池节点
	* 矿池服务器节点
	* 挖矿节点：挖矿

#### 功能
* 钱包
	* 管理密钥
	* 跟踪余额
* 挖矿
	* 运行工作量证明算法
	* 以竞争的方式创建新的区块
* 区块链
	* 保存一份完整的、最新的区块链拷贝
	* 独立自主地检验所有交易
* 网络路由
	* 验证、传播交易和区块信息
	* 发现、维持与对等节点的连接




## 挖矿和共识

### 概述
* 一种激励机制，实现了去中心化的安全
* 在去中心化的情况下实现了全网范围的共识
* 共识由许多独立节点遵守了简单的规则，通过异步交互自发形成的

### 重要过程
* 每个节点独立验证每个交易（依据综合标准）
* 每个挖矿节点独立将交易打包进区块（通过工作量证明算法）
* 每个节点独立对区块进行校验，并加入区块链
* 每个节点独立选择区块链（选择累积工作量最大的区块链）


### 工作量证明
* 在构建新区块时通过反复修改nonce值，计算出一个特定的区块头哈希值
	* 该哈希值要小于难度目标的哈希值


#### 难度调整
* 调整由每个节点独立完成
* 每生成2016个区块后就会调整一次
* 调整的目标：保证区块平均每10分钟生成一个
	* 区块生成速率比10分钟快就增加难度，比10分钟慢就降低难度


### 创币交易
* 区块中的第一笔交易
* 由挖矿节点自己构建：将奖励金额支付给矿工
* 奖励金额：coinbase奖励 + 区块中所有交易手续费（交易输入和输出的差值）




## 钱包

* 钱包只包含密钥，不是币。币被记录在区块链中

### 功能
* 管理多个密钥和地址
* 跟踪余额
	* 用包含的密钥可以消费的所有UTXO的总和
* 创建、签名交易


### 类型
* 非确定性钱包：每个密钥独立生成的，彼此无关（JBOK钱包）
* 确定性钱包：密钥从一个主密钥派生出来。（HB钱包）

### HB钱包
* 密钥以树状结构进行衍生
* 图示 ![](https://gitee.com/cc12703/figurebed/raw/master/img/20211231164433.png)

#### 优点
* 树状结构可以被用来表达附加的组织含义
* 可以在不需要对应私钥的情况下，创建一系列公钥