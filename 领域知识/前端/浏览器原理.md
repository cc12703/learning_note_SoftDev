


# 浏览器原理

[TOC]

## 总体

### 多进程架构
* 浏览器进程：负责界面显示、用户交互、子进程管理
* 渲染进程：负责解析HTML、CSS、JS，转换为网页
	* 每个Tab标签创建一个渲染进程
	* 渲染进程都运行在沙箱模式下
* GPU进程
* 网络进程：负责网络资源的加载
* 插件进程：负责插件的运行


### 导航流程
1. **浏览器**进程将输入的URL转发给**网络进程**
1. **网络进程**发起URL请求，接收响应头数据，转发给**浏览器进程**
1. **浏览器进程**发送提交导航消息到**渲染进程**
1. **渲染进程**从**网络进程**接收HTML数据
1. **渲染进程**发送确认提交消息到**浏览器进程**


### 渲染流程
1. 构建DOM树：将 HTML 文件 转换成 DOM 树
1. 样式计算：计算DOM树中每个节点的具体样式
	a. 将 CSS文本 转换成 styleSheets
	a. 标准化属性值
	a. 计算出DOM树中每个节点的具体样式，依据继承规则和层叠规则
1. 布局
	a. 创建布局树：该树只包含可见元素
	a. 布局计算：算出每个元素的几何坐标位置
1. 分层：将特定节点提升为专用图层，生成 图层树
1. 图层绘制：为每个图层生成一个绘制列表
1. 栅格化：将`图层`划分成`图块`，将`图块`转换成`位图`
1. 合成和显示：将页面内容绘制到内存，显示到屏幕上

#### 图示
![](http://picbed.cc12703.com/20220620002810.png)




### 页面运行
* 浏览器页面由**消息队列**和**事件循环**来驱动
* 渲染主线程会循环从**消息队列**中读取并执行任务
* 渲染进程使用一个IO线程来接收其他进程的消息



#### 图示
![](http://picbed.cc12703.com/20220620233304.png)



### 微任务方案
* 目的：权衡**效率**和**实时性**
	* 减少对当前任务执行效率的影响
	* 尽快的处理掉任务
* 消息队列中的任务为**宏任务**
* 每个宏任务中有一个**微任务**队列
* 宏任务完成后，会先执行当前宏任务中的微任务

#### 宏任务有什么
* 渲染事件：解析DOM、计算布局、绘制
* 用户交互事件
* JS脚本执行事件
* 网络请求完成事件
* 文件读写完成事件

#### 微任务有什么
* 监听DOM节点的变化
* Promise的resolve()和reject()
