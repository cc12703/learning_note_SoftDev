

# 分布式


## 订单系统


### 使用优惠券下单

#### 问题
* 需要保证订单系统和促销系统的数据更新操作保存一致
* 订单系统：写入订单数据，写入关联的优惠劵数据
* 促销系统：将优惠券更新为“已使用”状态


#### 方案
* 使用2PC（二阶段提交）
* 准备阶段：协调者向订单系统、促销系统发送“准备”命令
    * 两个系统要完成除提交数据库事务外的所有工作
* 提交阶段：协调者向订单系统、促销系统发送“提交”命令
    * 两个系统提交数据库事务

##### 异常情况
* 准备阶段异常：两个系统的数据库都会回滚
* 提交阶段异常：反复重试，直到成功为止


#### 总结
* 优点：满足强一致性，保证原子性和隔离性
* 缺点：并发性能不高，协调者是一个单点
* 适应情况：需要强一致性且并发量不大


### 订单结算

#### 问题
* 需要订单系统和购物车的数据更新操作保持一致
* 订单系统：创建新订单，加入购物中的商品
* 购物车系统：将商品中购物车中删除

#### 方案
* 使用本地消息表
* 订单系统在操作数据库时，在本地记录一条消息（清空购物车）
* 通过异步服务，读取本地消息，执行清空操作


#### 总结
* 保证最终一致性
* 前提条件：异步执行的操作，不能有依赖的资源