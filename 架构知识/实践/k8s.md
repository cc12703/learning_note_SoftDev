

# k8s


## 概述
* 一个基于容器的分布式架构解决系统
* 自动的部署、扩容、管理分布式应用


### 功能
* 面向容器：启动、停止、管理独立容器的生命周期
* 服务发现：运行应用的不同部分发现、通信其他部分
* 负载均衡：将流量分布式的分配给应用

### 思想
* 资源模型：将一切视为资源
* 控制器模式：每种资源都有`期望状态`和`实际状态`，由对应的控制器监视、调整





## 核心概念

### Pod
* k8s中的基本单位，相当于容器组
* 包含：一个Pause容器 + 多个业务容器
* 所有容器都共享网络栈和挂载卷
* 每个Pod都有一个唯一的IP地址
* 两个Pod之间可以直接进行网络通信


### Service
* 对分布式服务的一种抽象
* 唯一的名字
* 固定的入口：虚拟IP和端口

#### 虚拟IP（Cluster IP）
* 全局唯一的
* 在Service的整个生命周期内都不会变动


### Namespace
* 通过将资源对象分配到不同的命名空间中，在逻辑上进行分组



### ConfigMap
* 实现配置集中化功能
* 所有配置项都当成KV字符串
* 整个Map的数据被持久化存储在etcd中
* 配置值会通过卷映射的方式成为Pod内的配置文件



## 核心机制

### 应用模型
* 标签和标签选择器共同组成了应用模型
* `Label`：一个KV值（key=value），被附加到各种资源对象上
* `Label Selector`：查询和筛选特定标签的资源对象



#### 表达式
* 基于等式的：`<name> = <value>`
* 基于集合的：`<name> in (<value>,<value>,...)`
* 多个表达式与：`<expr>,<expr>,...`

#### 示例
```yml
//一个pod
apiVersion: v1
kind: Pod
metadata:
    name: myweb
    labels:
        app: myweb

//一个服务
apiVersion: v1
kind: Service
metadata:
    name: myweb
spec:
    selector:
        app: myweb
```


## 集群结构

### 概述
* 整个集群由多个机器组成，机器会有分工
* 机器被分为：主节点、工作节点
* 使用`etcd`存储数据

### 主节点（Master）
* 集群的控制节点（控制平面），是整个系统的大脑
* 通常需要3台服务器，保证高可用性

#### 组件
* `api-server`：提供REST接口、对资源操作的CURD接口
* `scheduler`：负责资源的调度（`Pod`调度）
* `controller-manager`：资源对象的自动化控制中心

### 工作节点（Node）
* 集群中的工作负载阶段，用于运行Docker容器

#### 组件
* `kubelet`：负责容器的创建、启停。与主节点协作实现集群管理
* `kube-proxy`：实现`Service`之间的通信、负载均衡



